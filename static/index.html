<!DOCTYPE html>
<html>

<head>
  <title>Floader</title>
</head>

<body>
  <h1>Hello, Floader!</h1>
  <form id="file-form" action="/api/upload" method="POST" enctype="multipart/form-data">
    <label for="file">Select file</label>
    <input type="file" id="file" name="file" multiple />
    <br />
    <button type="submit">Upload</button>
  </form>

  <form id="message-form">
    <label for="title">Title</label>
    <input type="text" id="title" name="title" />
    <br />
    <label for="message">Message</label>
    <input type="text" id="message" name="message" />

    <button type="submit">Send</button>
  </form>
  <p id="upload-result"></p>
</body>
<script>
  let sessionToken = "";

  const fileForm = document.getElementById("file-form");
  const messageForm = document.getElementById("message-form");
  const uploadResult = document.getElementById("upload-result");

  fileForm.addEventListener("submit", e => {
    e.preventDefault();

    const formData = new FormData(fileForm);

    while (!sessionToken) {
      const input = prompt("Session Token:")
      if (input === null) {
        return
      }
      sessionToken = input
    }


    fetch("/api/upload", {
      method: "POST",
      headers: {
        "Authorization": "Bearer " + sessionToken
      },
      body: formData
    })
      .then(async res => {
        if (res.status >= 400) {
          throw new Error(await res.text())
        }
        uploadResult.innerText = await res.text();
        setTimeout(() => uploadResult.innerText = "", 2000);
        fileForm.reset();
      })
      .catch(err => {
        uploadResult.innerText = "Error when uploading files: " + err;
        console.error("Error when uploading files:", err)
      });

  });

  messageForm.addEventListener("submit", e => {
    e.preventDefault();

    const formData = new FormData(messageForm);
    const title = formData.get("title");
    const body = formData.get("message");
    const timeSent = new Date();

    while (!sessionToken) {
      const input = prompt("Session Token:")
      if (input === null) {
        return
      }
      sessionToken = input
    }

    fetch("/api/message", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": "Bearer " + sessionToken
      },
      body: JSON.stringify({title, body, timeSent}),
    })
      .then(async res => {
        if (res.status >= 400) {
          throw new Error(await res.text())
        }
        uploadResult.innerText = await res.text();
        setTimeout(() => uploadResult.innerText = "", 2000);
        messageForm.reset();
      })
      .catch(err => {
        uploadResult.innerText = "Error when sending message: " + err;
        console.error("Error when sending message:", err);
      });

  });

  sessionToken = prompt("Session Token:")

</script>

</html>
